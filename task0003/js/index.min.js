define(["util"],function($){var gtd=function(){function createTab(isFirst){var category=getCategory().category;var missions=getMissions().missions;var tabUl=$("#tab-ul");var tabUlFragment=document.createDocumentFragment();var spanDeleteFolder=document.createElement("span");var allMissionCount=0;var oAllMission=$("#all-mission");spanDeleteFolder.className="delete-folder";for(var i=0,len=category.length;i<len;i++){var deepth=1;var oLi=recurTab(category[i],spanDeleteFolder,deepth,isFirst);allMissionCount+=parseInt(oLi.dataset.missionCount);tabUlFragment.appendChild(oLi)}tabUl.innerHTML="";tabUl.appendChild(tabUlFragment);oAllMission.innerHTML="所有任务 ("+allMissionCount+")"}function recurTab(curCate,spanDeleteFolder,deepth,isFirst){var taskLength=getMissionsCount();var folderCount=0;var tabLi=document.createElement("li");tabLi.className="tab-tree-li";var nameDiv=document.createElement("div");nameDiv.innerHTML=curCate.name;nameDiv.className="folder-name";nameDiv.dataset.folderId=curCate.folderId;nameDiv.appendChild(spanDeleteFolder.cloneNode());if(curCate.name==="默认分类"){nameDiv.id="protected";if(isFirst){$.addClass(nameDiv,"font-active")}}tabLi.appendChild(nameDiv);if(curCate.children){var childrenUl=document.createElement("ul");for(var i=0;i<curCate.children.length;i++){var childrenLi;if(curCate.children[i].children){childrenLi=arguments.callee(curCate.children[i],spanDeleteFolder,deepth+1);folderCount+=parseInt(childrenLi.dataset.missionCount)}else{childrenLi=document.createElement("li");childrenLi.innerHTML=curCate.children[i].name;for(var j=0,countLen=taskLength.length;j<countLen;j++){if(curCate.children[i].taskId===taskLength[j].taskId){folderCount+=parseInt(taskLength[j].count);childrenLi.innerHTML+=" ("+taskLength[j].count+")";break}}if(j===countLen){childrenLi.innerHTML+=" ("+0+")"}childrenLi.dataset.taskId=curCate.children[i].taskId}childrenUl.appendChild(childrenLi)}tabLi.appendChild(childrenUl);tabLi.dataset.missionCount=folderCount}nameDiv.innerHTML+=" ("+folderCount+")";return tabLi}function compareDeadline(mis1,mis2){if(mis1.time==="now"){return-1}if(mis2.time==="now"){return 1}return new Date(mis2.time).getTime()-new Date(mis1.time).getTime()}function getMissionByparentId(parentId,id,isNo){var missions=getMissions().missions;for(var i=0,len=missions.length;i<len;i++){if(missions[i].parentId===parseInt(parentId)){var children=missions[i].children;for(var j=0,childrenLen=children.length;j<childrenLen;j++){if(children[j].id===parseInt(id)){if(isNo){return[i,j]}return children[j]}}break}}return null}function addFolderToStorage(folderId,newFolderName){var categoryToAdd=getFolderById(folderId);categoryToAdd.push({name:newFolderName,folderId:getCategory().folderIdCount++,children:[]});updateStorage("category")}function deleteFolderToStorage(folderId){var category=getCategory().category;newCategory=cloneCategory(category,folderId);getCategory().category=newCategory;updateStorage("category");updateTabulation()}function cloneCategory(src,folderId){if(src===null){return"Null"}if(src===undefined){return"Undefined"}var key;var result;var srcClass=$.getType(src);if(srcClass==="Object"){result={}}else{if(srcClass==="Array"){result=[]}else{if(srcClass==="Number"||srcClass==="String"||srcClass==="Boolean"||srcClass==="Date"){return src}}}for(key in src){var attr=src[key];if($.getType(attr)==="Object"||$.getType(attr)==="Array"){if(srcClass==="Array"){var children=arguments.callee(attr,folderId);if(children){result.push(children)}}else{result[key]=arguments.callee(attr,folderId)}}else{if(key==="folderId"&&attr===folderId){src=null;return}else{result[key]=src[key]}}}return result}function getFolderById(folderId,categoryArr){var category=categoryArr||getCategory().category;if(folderId===-1){return category}else{for(var i=0,len=category.length;i<len;i++){if(category[i].folderId===folderId){return category[i].children}if(category[i].children){var categoryChildren=arguments.callee(folderId,category[i].children);if(categoryChildren){return categoryChildren}}}return null}}function getEditingMission(){var oContMissionBody=getMissionContElements().oContMissionBody;var parentId=oContMissionBody.dataset.parentId;var missionId=oContMissionBody.dataset.missionId;return getMissionByparentId(parentId,missionId)}function getActiveMission(){var oActiveDd=$("#mission-timeline .font-active");return getMissionByparentId(oActiveDd.dataset.parentId,oActiveDd.dataset.missionId)}function createNewMission(taskId){var missions=getMissions().missions;for(var i=0,len=missions.length;i<len;i++){if(missions[i].parentId===taskId){missions[i].children.push({name:"新任务",time:"now",type:"unfinish",text:"新任务内容",id:getMissions().missionId++});return}}missions.push({parentId:taskId,children:[{name:"新任务",time:"now",type:"unfinish",text:"新任务内容",id:getMissions().missionId++}]})}function _getMissionContElements(){var oContMissionBody=$("#cont-mission-body");var oContTitleBar=$("#cont-title-bar");var oMissionTitle=oContTitleBar.getElementsByTagName("h2")[0];var oMissionTime=$("#cont-mission-time span");var oFinishBtn=$("#finish-mission");var oEditBtn=$("#edit-mission");var oSaveEdit=$("#save-edit");var oCancelEdit=$("#cancel-edit");oContTitleBar=null;var contElements={oContMissionBody:oContMissionBody,oMissionTitle:oMissionTitle,oMissionTime:oMissionTime,oFinishBtn:oFinishBtn,oEditBtn:oEditBtn,oSaveEdit:oSaveEdit,oCancelEdit:oCancelEdit};return function(){return contElements}}var getMissionContElements=_getMissionContElements();function getMissionsCount(){var missions=getMissions().missions;var count=[];for(var i=0,len=missions.length;i<len;i++){var missionCount={taskId:missions[i].parentId,count:missions[i].children.length};count.push(missionCount)}return count}function switchMissonContBtns(type){var contElements=getMissionContElements();if(type==="edit"){contElements.oFinishBtn.style.display=contElements.oEditBtn.style.display="none";contElements.oSaveEdit.style.display=contElements.oCancelEdit.style.display="block"}else{if(type==="see"){contElements.oFinishBtn.style.display=contElements.oEditBtn.style.display="block";contElements.oSaveEdit.style.display=contElements.oCancelEdit.style.display="none"}}}function updateTabulation(){createTab(false)}function updateTimeline(type,isNewMission){var oMissionType=$("#mission-type");var aTypes=oMissionType.getElementsByTagName("a");var currentSelected;oTimelineOl=$("#mission-timeline ol"),targetSelect=undefined;oMissionType=null;for(var i=0;i<aTypes.length;i++){if($.hasClass(aTypes[i],"type-active")){currentSelected=aTypes[i]}if(aTypes[i].dataset.type===type){targetSelect=aTypes[i]}}$.removeClass(currentSelected,"type-active");$.addClass(targetSelect,"type-active");var currentTask=$("#tab-ul .font-active");if(!currentTask||currentTask.tagName.toUpperCase()!=="LI"){return}oTimelineOl.innerHTML="";oTimelineOl.appendChild(packTimeline(parseInt($("#tabulation .font-active").dataset.taskId),type));if(isNewMission){oTimelineOl.getElementsByTagName("dd")[0].click()}}function packTimeline(taskId,type){var missions=getMissions().missions;var liFragment=document.createDocumentFragment();for(var i=0,len=missions.length;i<len;i++){if(missions[i].parentId===taskId){var children=missions[i].children;children.sort(compareDeadline);for(var j=0,childrenLen=children.length;j<childrenLen;j++){if(children[j].type!==type&&type!=="all"){continue}var oLi=document.createElement("li");var oDl=document.createElement("dl");var oDt=document.createElement("dt");var oDd=document.createElement("dd");oDt.innerHTML=children[j].time;oDd.innerHTML=children[j].name;oDd.dataset.parentId=missions[i].parentId;oDd.dataset.missionId=children[j].id;oDl.appendChild(oDt);oDl.appendChild(oDd);while(j!==childrenLen-1&&children[j].time===children[j+1].time){j++;var oExtraDd=document.createElement("dd");oExtraDd.innerHTML=children[j].name;oExtraDd.dataset.parentId=missions[i].parentId;oExtraDd.dataset.missionId=children[j].id;oDl.appendChild(oExtraDd)}oLi.appendChild(oDl);liFragment.appendChild(oLi)}break}}if(i===len){var msgDiv=document.createElement("div");msgDiv.innerHTML="还没有任务哦<br/>点击下方添加任务";liFragment.appendChild(msgDiv)}else{if(!liFragment.childElementCount){var msgDiv=document.createElement("div");msgDiv.innerHTML="这个任务类型下还没有任务";liFragment.appendChild(msgDiv)}}return liFragment}function updateStorage(name){if(name==="category"){localStorage.setItem("category",JSON.stringify(getCategory()))}else{if(name==="missions"){localStorage.setItem("missions",JSON.stringify(getMissions()))}else{if(name==="all"){localStorage.setItem("category",JSON.stringify(getCategory()));localStorage.setItem("missions",JSON.stringify(getMissions()))}}}}function _getCategory(){var tempCategory=JSON.parse(localStorage.getItem("category"))||{category:[{name:"百度IFE项目",folderId:1,children:[{name:"task1",taskId:1},{name:"task2",taskId:2},{name:"部分",folderId:2,children:[{name:"h1",taskId:3}]}]},{name:"毕业论文",folderId:4,children:[]},{name:"社团",folderId:5,children:[]},{name:"默认分类",folderId:0,children:[{name:"默认task",taskId:0}]}],taskIdCount:6,folderIdCount:5};if(!localStorage.getItem("category")){localStorage.setItem("category",JSON.stringify(tempCategory))}return function(){return tempCategory}}var getCategory=_getCategory();function _getMissions(){var tempMissions=JSON.parse(localStorage.getItem("missions"))||{missions:[{parentId:0,children:[{name:"默认任务",time:"2015-06-01",type:"unfinish",id:0,text:"默认任务内容，什么都没有\n啊"}]},{parentId:1,children:[{name:"to-do-1",time:"2015-05-04",type:"unfinish",id:1,text:"adasdadadasds\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg"},{name:"to-do-2",time:"2015-04-01",type:"finish",text:"rg",id:2},{name:"to-do-3",time:"2015-05-01",type:"finish",text:"rg1",id:3},{name:"to-do-4",time:"2015-04-30",type:"unfinish",text:"r",id:4},{name:"to-do-6",time:"2015-04-30",type:"unfinish",text:"r",id:5},{name:"to-do-9",time:"2015-04-30",type:"unfinish",text:"r",id:12}]},{parentId:2,children:[{name:"to-do-2",time:"2015-05-01",type:"finish",text:"rg",id:23},{name:"to-do-3",time:"2015-05-01",type:"finish",text:"rg1",id:34},{name:"to-do-4",time:"2015-04-30",type:"unfinish",text:"r",id:56}]}],missionId:56};if(!localStorage.getItem("missions")){localStorage.setItem("missions",JSON.stringify(tempMissions))}return function(){return tempMissions}}var getMissions=_getMissions();function GTDOnclickFunctions(){try{switchMissionType();selectMission();selectTask();editMission();addTab();addMission();saveEdit();cancelEdit();finishMission();deleteFolder()}catch(e){console.log(e)}}function switchMissionType(){var oMissionType=$("#mission-type");var aTypes=oMissionType.getElementsByTagName("a");var currentSelected=aTypes[0];var oTimelineOl=$("#mission-timeline ol");var oMissionType=null;$.delegate("#mission-type","a","click",function(ev){if(!$.hasClass(this,"type-active")){currentSelected=$("#mission-type .type-active")}$.removeClass(currentSelected,"type-active");$.addClass(this,"type-active");currentSelected=this;var currentTask=$("#tab-ul .font-active");if(!currentTask||currentTask.tagName.toUpperCase()!=="LI"){return}oTimelineOl.innerHTML="";oTimelineOl.appendChild(packTimeline(parseInt($("#tabulation .font-active").dataset.taskId),this.dataset.type));var aDd=oTimelineOl.getElementsByTagName("dd");for(var i=0,len=aDd.length;i<len;i++){if(aDd[i].dataset.missionId===getMissionContElements().oContMissionBody.dataset.missionId){$.addClass(aDd[i],"font-active")}}})}function selectTask(){var oTabUl=$("#tab-ul");var missions=getMissions().missions;var oTimelineOl=$("#mission-timeline ol");var currentSelected=$("#protected");var selectedId;$.delegate("#tab-ul","li","click",function(ev){if(!$.hasClass(this,"tab-tree-li")&&!$.hasClass(this,"font-active")){if(currentSelected){$.removeClass(currentSelected,"font-active")}$.addClass(this,"font-active");currentSelected=this;oTimelineOl.innerHTML="";oTimelineOl.appendChild(packTimeline(parseInt(this.dataset.taskId),$("#mission-type .type-active").dataset.type))}});$.delegate("#tabulation","div","click",function(ev){if(!$.hasClass(this,"font-active")&&this.id!=="tabulation"&&this.id!=="tab-title"){if(currentSelected){$.removeClass(currentSelected,"font-active")}$.addClass(this,"font-active");currentSelected=this;oTimelineOl.innerHTML="请点击具体任务"}})}function selectMission(){var ocurrentSelected;$.delegate("#mission-timeline ol","dd","click",function(ev){if(!$.hasClass(this,"font-active")){var contElements=getMissionContElements();if($.hasClass(contElements.oContMissionBody,"mission-editing")){if(!confirm("正在编辑中，要放弃保存吗")){return}else{switchMissonContBtns("see");$.removeClass(contElements.oContMissionBody,"mission-editing")}}if(ocurrentSelected){$.removeClass(ocurrentSelected,"font-active")}ocurrentSelected=this;$.addClass(this,"font-active");var mission=getMissionByparentId(this.dataset.parentId,this.dataset.missionId);contElements.oMissionTitle.innerHTML=this.innerHTML;contElements.oMissionTime.innerHTML=mission.time;contElements.oContMissionBody.innerHTML=mission.text.replace(/\n/g,"<br/>");contElements.oContMissionBody.dataset.parentId=this.dataset.parentId;contElements.oContMissionBody.dataset.missionId=this.dataset.missionId;if(!contElements.oFinishBtn.style.display||contElements.oFinishBtn.style.display==="none"){contElements.oFinishBtn.style.display=contElements.oEditBtn.style.display="block"}}})}function editMission(){$.on("#edit-mission","click",function(){var contElements=getMissionContElements();var oEditArea=document.createElement("textarea");oEditArea.id="cont-mission-edit";oEditArea.innerHTML=$.htmlReturn(contElements.oContMissionBody.innerHTML).replace(/\<br\>/g,"\n");contElements.oContMissionBody.innerHTML="";$.addClass(contElements.oContMissionBody,"mission-editing");contElements.oContMissionBody.appendChild(oEditArea);var oEditTitle=document.createElement("input");oEditTitle.id="cont-title-edit";oEditTitle.type="text";oEditTitle.value=$.htmlReturn(contElements.oMissionTitle.innerHTML);contElements.oMissionTitle.innerHTML="";contElements.oMissionTitle.appendChild(oEditTitle);var oEditTime=document.createElement("input");oEditTime.id="cont-time-edit";oEditTime.type="text";oEditTime.value=contElements.oMissionTime.innerHTML==="now"?"yyyy-mm-dd":contElements.oMissionTime.innerHTML;contElements.oMissionTime.innerHTML="";contElements.oMissionTime.appendChild(oEditTime);switchMissonContBtns("edit")})}function saveEdit(){$.on("#save-edit","click",function(){var contElements=getMissionContElements();var oEditArea=$("#cont-mission-edit");var oEditTitle=$("#cont-title-edit");var oEditTime=$("#cont-time-edit");var mission=getEditingMission();if(!Number(new Date(oEditTime.value).getTime())){alert("日期输入有误");return}mission.name=$.htmlEscape(oEditTitle.value);mission.time=$.htmlEscape(oEditTime.value);mission.text=$.htmlEscape(oEditArea.value);updateStorage("missions");contElements.oMissionTitle.innerHTML=mission.name;contElements.oMissionTime.innerHTML=mission.time;contElements.oContMissionBody.innerHTML=mission.text.replace(/\n/g,"<br>");$.removeClass(contElements.oContMissionBody,"mission-editing");switchMissonContBtns("see")})}function cancelEdit(){$.on("#cancel-edit","click",function(){var contElements=getMissionContElements();var mission=getEditingMission();if($.hasClass(contElements.oContMissionBody,"mission-editing")){if(!confirm("正在编辑中，要放弃保存吗")){return}else{switchMissonContBtns("see");$.removeClass(contElements.oContMissionBody,"mission-editing");contElements.oMissionTitle.innerHTML=mission.name;contElements.oMissionTime.innerHTML=mission.time;contElements.oContMissionBody.innerHTML=mission.text.replace(/\n/g,"<br/>")}}})}function finishMission(){$.on("#finish-mission","click",function(){var mission=getActiveMission();if(mission.type==="finish"){alert("任务已经完成啦");return}if(confirm("确认完成任务吗?")){mission.type="finish";alert("任务完成！");updateStorage("missions")}})}function deleteFolder(){$.delegate("#tab-ul","span","click",function(){if(this.parentNode.id==="protected"){alert("默认文件夹不能删除");return}if($.hasClass(this,"delete-folder")&&confirm("确定要删除这个文件夹吗")){var currentFolder=this.parentNode;var folderId=parseInt(currentFolder.dataset.folderId);deleteFolderToStorage(folderId)}})}function addTab(){$.on("#add-tab","click",function(){var tabPrompt=prompt("在当前分类下添加分类，请输入分类名字","分类");while($.trim(tabPrompt)===""){alert("请输入分类名字呀");tabPrompt=prompt("在当前分类下添加分类，请输入分类名字","分类")}if(tabPrompt===null){return}var oActiveTab=$("#tabulation .font-active");var folderId=0;while(oActiveTab.tagName.toUpperCase()!=="DIV"){oActiveTab=oActiveTab.parentNode;var childrenElm=$.getDomChildren(oActiveTab);for(var i=0,len=childrenElm.length;i<len;i++){if(childrenElm[i].tagName.toUpperCase()==="DIV"){oActiveTab=childrenElm[i]}}}if(oActiveTab.id==="all-mission"){folderId=-1}else{folderId=parseInt(oActiveTab.dataset.folderId)}addFolderToStorage(folderId,tabPrompt);updateTabulation()})}function addMission(){$.on("#add-mission","click",function(){var oActiveTab=$("#tab-ul .font-active");if(oActiveTab.tagName.toUpperCase()!=="LI"){alert("请选择具体task来增加任务");return}createNewMission(parseInt(oActiveTab.dataset.taskId));updateTimeline("all",true);updateTabulation();$("#edit-mission").click()})}return function(){createTab(true);GTDOnclickFunctions()}};return gtd});